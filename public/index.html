<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片处理器</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <div id="response-message" class="message"></div>
        <h1>PDF 生成器</h1>
        <p>请在下方输入包含JPG图片的完整文件夹路径，然后点击生成。</p>
        <form id="pdf-form">
            <input type="text" name="folderPath" placeholder="例如: /Users/bangle/lebang/img-processor/test/A.幸福  大框1个 （1张横图）100x60" value="/Users/bangle/lebang/img-processor/test" required>
            <button type="submit">
                <span class="spinner"></span>
                生成PDF
            </button>
        </form>


        <form id="prod-form" style="margin-top: 10px;">
            <button type="submit">
                <span class="spinner"></span>
                生成生产文件夹
            </button>
        </form>
    </div>

    <script>
        const form = document.getElementById('pdf-form');
        const input = form.querySelector('input');
        const button = form.querySelector('button');
        const responseDiv = document.getElementById('response-message');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const formData = new FormData(form);
            const folderPath = formData.get('folderPath');

            // Reset state
            input.disabled = true;
            button.classList.add('loading');
            button.disabled = true;
            responseDiv.style.display = 'none';
            responseDiv.textContent = '';

            try {
                const response = await fetch('/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ folderPath })
                });

                const result = await response.json();

                responseDiv.textContent = result.message;
                if (result.success) {
                    responseDiv.className = 'message success';
                } else {
                    responseDiv.className = 'message error';
                }
                responseDiv.style.display = 'block';

            } catch (error) {
                responseDiv.textContent = '发生意外错误，请检查终端日志。';
                responseDiv.className = 'message error';
                responseDiv.style.display = 'block';
            } finally {
                input.disabled = false;
                button.classList.remove('loading');
                button.disabled = false;
            }
        });
        const prodForm = document.getElementById('prod-form');
        const prodButton = prodForm.querySelector('button');

        prodForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const folderPath = form.querySelector('input[name="folderPath"]').value;

            // Reset state
            input.disabled = true;
            button.disabled = true;
            prodButton.classList.add('loading');
            prodButton.disabled = true;
            responseDiv.style.display = 'none';
            responseDiv.textContent = '';

            try {
                const response = await fetch('/prod-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ folderPath })
                });

                const result = await response.json();

                responseDiv.textContent = result.message;
                if (result.success) {
                    responseDiv.className = 'message success';
                } else {
                    responseDiv.className = 'message error';
                }
                responseDiv.style.display = 'block';

            } catch (error) {
                responseDiv.textContent = '发生意外错误，请检查终端日志。';
                responseDiv.className = 'message error';
                responseDiv.style.display = 'block';
            } finally {
                input.disabled = false;
                button.disabled = false;
                prodButton.classList.remove('loading');
                prodButton.disabled = false;
            }
        });
    </script>
</body>
</html>
